# Managing Secrets for ECS Tasks Using SSM Parameter Store and IAM Roles

## Step 1: Create KMS Keys

`./create-kms-keys.sh`

## Step 2: Create an ECS Task IAM Role and Policy

```bash
AWS_ACCOUNT_ID=<Your_AWS_Account_ID>
aws iam create-role --role-name prod-app1 --assume-role-policy-document file://ecs-tasks-trust-policy.json
aws iam create-policy --policy-name prod-app1 --policy-document file://app1-secret-access.json
aws iam attach-role-policy --role-name prod-app1 --policy-arn "arn:aws:iam::$AWS_ACCOUNT_ID:policy/prod-app1"
```

## Step 3: Upload Test Script to S3

Upload `access-test.sh` to an S3 bucket in your account. Create a new bucket, or use an existing one.

Make sure the object is publicly accessible and note down the object link, for example `https://s3.amazonaws.com/my-new-bucket/access-test.sh`

## Step 4: Create ECS Cluster

Create a CloudFormation stack using `cf.yml`.

Example: `aws cloudformation create-stack --capabilities CAPABILITY_NAMED_IAM --stack-name ParameterStore --template-body file://cf.yml`

## Step 5: Register Task Definition

Be sure to set values for `ACCOUNT_ID` and `S3_URI` in `create-taskdef.sh` before running this script.

`./create-taskdef.sh` will create a task definition called `access-test`.

## Step 6: Run Task

This will run the task definition `access-test` created in the previous step. Replace `<CLUSTER_NAME>` with the name of the cluster generated by CloudFormation:

`aws ecs run-task --cluster <CLUSTER_NAME> --task-definition access-test --count 1 --region us-east-1`

## Step 7: Verify Access

After the task is in a running state, check the public IP of the container instance and navigate to the following page:

`http://<Container-Instance-Public-IP>/ecs.html`

Only the first command with the `--no-with-decryption` parameter should work. The policy allows access to the parameter in Parameter Store but thereâ€™s no access to the KMS key.

The second command should fail with an access denied error.